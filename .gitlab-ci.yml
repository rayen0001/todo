stages:
  - test
  - security_check
  - dockerize
  - deploy

# Lint Job
lint:
  stage: test
  image: python:3.9
  script:
    - echo "Installing dependencies for linting..."
    - pip install -r requirements.txt
    - pip install pylint
    - echo "Running linting..."
    - pylint *.py  
  allow_failure: false
  rules:
    - if: '$CI_COMMIT_BRANCH != "main"'  
    - if: '$CI_COMMIT_BRANCH == "main"' 

# Unit Test Job
unit_test:
  stage: test
  image: python:3.9
  script:
    - echo "Setting up environment..."
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - echo "Running unit tests..."
    - pytest unit_test.py
  artifacts:
    paths:
      - .venv/
    expire_in: 1 hour
  allow_failure: false
  rules:
    - if: '$CI_COMMIT_BRANCH != "main"'  
    - if: '$CI_COMMIT_BRANCH == "main"' 

# Integration Test Job
integration_test:
  stage: test
  image: python:3.9
  script:
    - echo "Setting up environment for integration tests..."
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - echo "Running integration tests..."
    - pytest integration_test.py  
  artifacts:
    paths:
      - .venv/
    expire_in: 1 hour
  allow_failure: false
  rules:
    - if: '$CI_COMMIT_BRANCH != "main"'  
    - if: '$CI_COMMIT_BRANCH == "main"' 

# Security Check Job
security_check:
  stage: security_check
  image: python:3.9
  script:
    - echo "Installing dependencies for security checks..."
    - pip install -r requirements.txt
    - pip install bandit safety
    - echo "Running Bandit (static analysis)..."
    - bandit -r .
    - echo "Running Safety (dependency vulnerability check)..."
    - safety check -r requirements.txt
  allow_failure: false
  rules:
    - if: '$CI_COMMIT_BRANCH != "main"'  
    - if: '$CI_COMMIT_BRANCH == "main"' 

# Dockerize Job
dockerize:
  stage: dockerize
  image: docker:20.10.23
  services:
    - docker:20.10.23-dind
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - docker build -t $DOCKER_USERNAME/todo-app:latest .
    - docker push $DOCKER_USERNAME/todo-app:latest
  after_script:
    - docker inspect $DOCKER_USERNAME/todo-app:latest --format='{{index .RepoDigests 0}}' > image-digest.txt || echo "No digest available"
  artifacts:
    paths:
      - image-digest.txt
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'  

# Deploy Job
deploy:
  stage: deploy
  image: ubuntu:latest
  before_script:
   - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
   - eval $(ssh-agent -s)
   - mkdir -p ~/.ssh
   - echo "$EC2_SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/test.pem
   - chmod 600 ~/.ssh/test.pem
  script:
    - ssh -T -o StrictHostKeyChecking=no -i ~/.ssh/test.pem $EC2_HOST "sudo docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" "
    - ssh -T -o StrictHostKeyChecking=no -i ~/.ssh/test.pem $EC2_HOST "sudo docker pull $DOCKER_USERNAME/todo-app:latest"
    - ssh -T -o StrictHostKeyChecking=no -i ~/.ssh/test.pem $EC2_HOST "sudo docker run -itd -p 80:8000 $DOCKER_USERNAME/todo-app:latest"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'  
